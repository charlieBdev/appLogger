@model List<appLogger.Models.Logging>
@using System.Text.Json

@{
    ViewData["Title"] = "Logs Page";

    // Full loggingDatabases is on server only
    var apps = ViewBag.Apps as List<string> ?? new List<string>();
    var envsPerApp = ViewBag.EnvsPerApp as Dictionary<string, List<string>> ?? new Dictionary<string, List<string>>();
}

<h2>Logs</h2>

<form id="filterForm" class="mb-3">
    <div class="d-flex">
        <div class="d-flex flex-column me-3">
            <label for="appName" class="form-label">App:</label>
            <select id="appName" name="appName" class="form-select">
                <option value="">Select App</option>
                @foreach (var app in apps)
                {
                    <option value="@app">@app</option>
                }
            </select>
        </div>

        <div class="d-flex flex-column me-3">
            <label for="envName" class="form-label">Environment:</label>
            <select id="envName" name="envName" class="form-select">
                <option value="">Select Environment</option>
            </select>
        </div>

        <button type="submit" class="btn btn-primary align-self-end me-3">Show Logs</button>
        <p id="appAndEnvShown" class="align-self-end mb-2"></p>
    </div>
</form>

<div id="logsContainer">
    <!-- Table will appear here after submit -->
</div>

@section Scripts {
<script>
    const envsPerApp = @Html.Raw(JsonSerializer.Serialize(envsPerApp));
    const appSelect = document.getElementById('appName');
    const envSelect = document.getElementById('envName');
    const form = document.getElementById('filterForm');
    const logsContainer = document.getElementById('logsContainer');
    const appAndEnvShown = document.getElementById('appAndEnvShown');

    // Populate environments when app changes
    appSelect.addEventListener('change', () => {
        const selectedApp = appSelect.value;
        envSelect.innerHTML = '<option value="">Select Environment</option>';

        if (selectedApp && envsPerApp[selectedApp]) {
            envsPerApp[selectedApp].forEach(env => {
                const option = document.createElement('option');
                option.value = env;
                option.text = env;
                envSelect.appendChild(option);
            });
        }
    });

    // Submit form via AJAX
    form.addEventListener('submit', event => {
        event.preventDefault();
        const appName = appSelect.value;
        const envName = envSelect.value;

        if (!appName || !envName) {
            logsContainer.innerHTML = '<p>Please select both App and Environment.</p>';
            return;
        }

        logsContainer.innerHTML = '<p>Loading logs...</p>';

        // Server-side fetch â€” connection strings are never exposed to the client
        fetch(`@Url.Action("Index", "Logs")?appName=${appName}&envName=${envName}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(res => res.json())
        .then(logs => {
            if (!logs.length) {
                logsContainer.innerHTML = '<p>No logs to display.</p>';
                return;
            }

            let html = '<table class="table"><thead><tr><th>Id</th><th>Timestamp</th><th>Level</th><th>Message</th><th>Username</th></tr></thead><tbody>';
            logs.forEach(log => {
                html += `<tr>
                            <td>${log.id}</td>
                            <td>${new Date(log.timestamp).toLocaleString()}</td>
                            <td>${log.level}</td>
                            <td>${log.message}</td>
                            <td>${log.username}</td>
                        </tr>`;
            });
            html += '</tbody></table>';

            logsContainer.innerHTML = html;
            appAndEnvShown.innerText = `Showing logs for ${appName} > ${envName}`;
        })
        .catch(err => {
            logsContainer.innerHTML = '<p>Error loading logs.</p>';
            console.error(err);
        });
    });

    const apps = @Html.Raw(JsonSerializer.Serialize(apps));
    console.log(apps, envsPerApp);
</script>
}
