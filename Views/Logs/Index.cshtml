@model List<appLogger.Models.Logging>

@{
    ViewData["Title"] = "Logs Page";

    var apps = ViewBag.Apps as List<string> ?? new List<string>();
    var envs = ViewBag.Envs as List<string> ?? new List<string>();
    var selectedApp = ViewBag.SelectedApp as string ?? "";
    var selectedEnv = ViewBag.SelectedEnv as string ?? "";
    var loggingDatabases = ViewBag.LoggingDatabases;
}

<h2>Logs</h2>

<form id="filterForm" class="mb-3">
    <div class="d-flex">
        <div class="d-flex flex-column me-3">
            <label for="appName" class="form-label">App:</label>
            <select id="appName" name="appName" class="form-select">
                <option value="">Select App</option>
                @foreach (var app in apps)
                {
                    <option value="@app" selected="@(selectedApp == app)">@app</option>
                }
            </select>
        </div>

        <div class="d-flex flex-column me-3">
            <label for="envName" class="form-label">Environment:</label>
            <select id="envName" name="envName" class="form-select">
                <option value="">Select Environment</option>
                @foreach (var env in envs)
                {
                    <option value="@env" selected="@(selectedEnv == env)">@env</option>
                }
            </select>
        </div>

        <button type="submit" class="btn btn-primary align-self-end me-3">Show Logs</button>
        <p id="appAndEnvShown" class="align-self-end mb-2"></p>
    </div>
</form>

<div id="logsContainer">
    <!-- Table will appear here after submit -->
</div>

@section Scripts {
<script>
    const loggingDatabases = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(loggingDatabases));
    const appSelect = document.getElementById('appName');
    const envSelect = document.getElementById('envName');
    const form = document.getElementById('filterForm');
    const logsContainer = document.getElementById('logsContainer');
    const appAndEnvShown = document.getElementById('appAndEnvShown');

    // Refresh environments when app changes
    appSelect.addEventListener('change', function () {
        const selectedApp = this.value;
        envSelect.innerHTML = '<option value="">Select Environment</option>';
        if (selectedApp && loggingDatabases[selectedApp]) {
            Object.keys(loggingDatabases[selectedApp]).forEach(env => {
                const option = document.createElement('option');
                option.value = env;
                option.text = env;
                envSelect.appendChild(option);
            });
        }
    });

    // Submit form via AJAX, update table without reload
    form.addEventListener('submit', function (event) {
        event.preventDefault();
        const appName = appSelect.value;
        const envName = envSelect.value;

        if (!appName || !envName) {
            logsContainer.innerHTML = '<p>Please select both App and Environment.</p>';
            return;
        }

        fetch(`@Url.Action("Index", "Logs")?appName=${appName}&envName=${envName}`, {
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(logs => {
            if (!logs.length) {
                logsContainer.innerHTML = '<p>No logs to display.</p>';
                return;
            }

            // Build table dynamically
            let html = '<table class="table"><thead><tr><th>Id</th><th>Timestamp</th><th>Level</th><th>Message</th></tr></thead><tbody>';
            logs.forEach(log => {
                html += `<tr>
                            <td>${log.id}</td>
                            <td>${log.timestamp}</td>
                            <td>${log.level}</td>
                            <td>${log.message}</td>
                        </tr>`;
            });
            html += '</tbody></table>';

            logsContainer.innerHTML = html;
            appAndEnvShown.innerText = `Showing logs for ${appName} > ${envName}`;
        })
        .catch(err => {
            logsContainer.innerHTML = '<p>Error loading logs.</p>';
            console.error(err);
        });
    });
</script>
}
